<!DOCTYPE html>
<html lang="ja">

<head>
	<title>secret base</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet"/>
  <script>
    window.addEventListener('DOMContentLoaded', function() {
      // クエリパラメータでデータが与えられている場合は自動読み込み
      const searchParams = new URLSearchParams(window.location.search);
      if (!searchParams.has('mosaicId') || !searchParams.has('netType')) {
        visibleElement('inputArea');
        return;
      }
      
      // パラメータの取得と検証
      const queryMosaicId = searchParams.get('mosaicId');
      const queryNetType = searchParams.get('netType');
      netType = -1;
      switch (queryNetType) {
        case '104':
        case 'main':
          netType = "104";
          break;

        case '152':
        case 'test':
          netType = "152";
          break;

        default:
          return;
      }
      getMosaicInfo(queryMosaicId, netType);
    });
  </script>
</head>

<body id="top">
	<article>
    <section class="container d-none" id="inputArea">
      <form id="formMosaic">
        <div class="mb-3 row">
          <label for="inputMosaicId" class="col-sm-2 col-form-label">Mosaic ID</label>
          <div class="col-sm-10">
            <input type="text" class="form-control" id="inputMosaicId" placeholder="Input Mosaic ID...">
          </div>
          <label for="inputNetType" class="col-sm-2 col-form-label">NET Type</label>
          <div class="col-sm-10">
            <select class="form-select" id="inputNetType" aria-label="Select NET Type">
              <option selected value="104">MAIN NET</option>
              <option value="152">TEST NET</option>
            </select>
          </div>
          <div class="col-sm">
            <button type="button" class="btn btn-primary" id="buttonGet" onclick="onGetButtonClick()">
              Get Mosaic Data
            </button>
          </div>
        </div>
      </form>
    </section>
    <section class="d-none" id="loadArea">
      <div class="position-fixed top-50 start-50 translate-middle text-center">
        <div class="spinner-border text-secondary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <h3 class="animate__animated animate__fadeIn animate__infinite">Now Loading...</h3>
      </div>
    </section>
    <section class="container animate__animated animate__fadeIn text-break d-none" id='mosaicDataArea'>
      <article class="container" id="onChainDataArea"></article>
      <article class="container" id="mosaicInfoArea">
        <div class="row">
          <div class="col-12 text-center"><h4>Mosaic Information</h4></div>
        </div>
      </article>
    </section>
  </article>
</body>

<template id="templateOnChainDataArea">
  <article class="container animate__animated animate__fadeIn">
    <div class="row">
      <div class="col-lg-6 align-self-center text-center data__data"></div>
      <div class="col-lg-6 align-self-center data__meta">
        <h6 class="text-muted data__date"></h6>
        <h3 class="data__title"></h3>
        <p class="data__description"></p>
      </div>
    </div>
  </article>
</template>
<template id="templateOnChainImageData">
  <img class="img-fluid w-100 border border-4 rounded-2 border-light" src="" alt="On Chain Data">
</template>
<template id="templateOnChainAudioData">
  <audio src="" controls="true" autoplay="true" loop="true"></audio>
</template>
<template id="templateMosaicInfoRow">
  <div class="col-3"><p class="mosaic_info_col__title"></p></div>
  <div class="col-9"><p class="mosaic_info_col__content"></p></div>
</template>

<script src="resource/bundle.min.js"></script>
<script>
  async function onGetButtonClick() {
    document.forms.formMosaic.buttonGet.disabled = true;
    await getMosaicInfo(
      document.forms.formMosaic.inputMosaicId.value,
      document.forms.formMosaic.inputNetType.value
    );
    document.forms.formMosaic.buttonGet.disabled = false;
  }

  async function getMosaicInfo(mosaicId, netType) {
    visibleElement('loadArea');
    mosaicData = await getOnChainData(mosaicId, netType);
    onChainDataArea = document.getElementById('onChainDataArea');
    if (null === mosaicData) {
      onChainDataArea.appendChild(createNoImageArea());
    } else {
      if (null === mosaicData.data || 0 === mosaicData.data.length) {
        onChainDataArea.appendChild(createNoImageArea());
      } else {
        mosaicData.data.forEach(onChainData => {
          onChainDataArea.appendChild(createOnChainDataArea(onChainData));
        });
      }
      createMosaicInfoDataArea(mosaicData);
    }
    invisibleElement('loadArea');
    visibleElement('mosaicDataArea');
  }

  function createMosaicInfoDataArea(mosaicData) {
    mosaicInfoArea = document.getElementById('mosaicInfoArea');
    mosaicInfoRow = mosaicInfoArea.firstElementChild;

    mosaicInfoRow.appendChild(createDataColumnElement('MosaicId', mosaicData.mosaicId));
    mosaicInfoRow.appendChild(createDataColumnElement('Alias', mosaicData.alias));
    mosaicInfoRow.appendChild(createDataColumnElement('Supply', mosaicData.supply));
    mosaicInfoRow.appendChild(createDataColumnElement('Height', mosaicData.height));
    mosaicInfoRow.appendChild(createDataColumnElement('Date', mosaicData.date));
    mosaicInfoRow.appendChild(createDataColumnElement('Address', mosaicData.owner));
    mosaicInfoRow.appendChild(createDataColumnElement('SupplyMutable', mosaicData.supplyMutable));
    mosaicInfoRow.appendChild(createDataColumnElement('Transferable', mosaicData.transferable));
    mosaicInfoRow.appendChild(createDataColumnElement('Restrictable', mosaicData.restrictable));
    mosaicInfoRow.appendChild(createDataColumnElement('Revokable', mosaicData.revokable));
  }

  function getOnChainDataElement(data) {
    const startIdx = ('string' === typeof(data)) ? data.indexOf('data:') : -1;
    const endIdx = (-1 < startIdx) ? data.indexOf('base64', startIdx) : -1;
    const dataType = ((-1 < startIdx) && (-1 < endIdx)) ? data.substring(startIdx + 'data:'.length, endIdx) : null;
    let templateDataName = '';
    switch (dataType) {
      case 'image/png;':
      case 'image/jpeg;':
        templateDataName = 'templateOnChainImageData';
        break;
    
      case 'audio/mpeg;':
        templateDataName = 'templateOnChainAudioData';
        break;
    
      default:
        templateDataName = 'templateOnChainImageData';
        data = 'resource/nodata.png';
        break;
    }
    const template = document.getElementById(templateDataName);
    const clone = template.content.cloneNode(true);
    clone.firstElementChild.src = data;
    return clone;
  }

  function createOnChainDataArea(onChainData) {
    const template = document.getElementById('templateOnChainDataArea');
    const clone = template.content.cloneNode(true);
    clone.querySelector('.data__data').appendChild(getOnChainDataElement(onChainData.data));
    clone.querySelector('.data__date').innerText = onChainData.date;
    clone.querySelector('.data__title').innerText = onChainData.title;
    clone.querySelector('.data__description').innerText = onChainData.description;
    return clone;
  }

  function createNoImageArea() {
    const template = document.getElementById('templateOnChainDataArea');
    const clone = template.content.cloneNode(true);
    clone.querySelector('.data__data').appendChild(getOnChainDataElement(null));
    clone.querySelector('.data__meta').remove();
    return clone;
  }

  function createDataColumnElement(key, data) {
    const template = document.getElementById('templateMosaicInfoRow');
    const clone = template.content.cloneNode(true);
    clone.querySelector('.mosaic_info_col__title').innerText = key;
    clone.querySelector('.mosaic_info_col__content').innerText = ((null !== data) ? data : 'N/A');
    return clone;
  }

  function visibleElement(elementId) {
    loadArea = document.getElementById(elementId);
    loadArea.classList.add("d-block");
    loadArea.classList.remove("d-none");
  }

  function invisibleElement(elementId) {
    loadArea = document.getElementById(elementId);
    loadArea.classList.add("d-none");
    loadArea.classList.remove("d-block");
  }
</script>

</html>